name: Fetch local upstream
on:
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Find branches to fetch upstream from
        run: |
          echo "Finding branches..."
          rm -rf wksp
          mkdir -p wksp
          cd wksp
          touch b.txt
          echo $(curl -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/XaverianTeamRobotics/FtcRobotController/branches | jq '[.[] | {name: .name}]') > b.txt
          echo $(jq -r .[].name b.txt) > b.txt
          echo $(cat b.txt | tr " " "\n") > b.txt
          echo "Branches found! - $(cat b.txt)"
          for i in `cat b.txt`;
          do
            if [[ $i == testing-* ]]
            then
              echo "Queueing merge into $i"
              rm -rf cb.txt
              touch cb.txt
              echo $(date +%s%N) > cb.txt
              rm -rf r
              mkdir -p r
              cd r
              sha256sum ../cb.txt > cbh.txt
              GEN="1139eed6e11bcc56075f490e85e80457f26b85b7928b0cfbf7b1138267e48bc5"
              VAL="1643931846884967030"
              gh workflow run --repo XaverianTeamRobotics/FtcRobotController --ref master merger.yml -f into=$i -f gen=$GEN -f val=$VAL
              echo "Merge queued!"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.MASS_MERGE_TOKEN }}
